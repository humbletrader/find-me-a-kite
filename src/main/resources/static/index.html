<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">

    <title>Find me a kite</title>
</head>
<body>
<h1>Find me a kite </h1>

<!-- Optional JavaScript; choose one of the two! -->

<!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>

<div class="container">
    <input type="button" onclick="find()" name="find" value="Find" />

    <select id="category" name="category" onchange="populateBrands()">
        <option value="KITES" >kite</option>
        <option value="TWINTIPS">twintip</option>
        <option value="BARS">bar</option>
    </select>

    <select id="brand" name="brand" onchange="populateProductNames()">
        <option value="NONE">none</option>
    </select>

    <select id="name" name="name" onchange="populateVersion()">
        <option value="NONE">none</option>
    </select>

    <select id="version" name="version">
        <option value="NONE">none</option>
    </select>

    <div id="searchResults">

    </div>
</div>


<script>
    function populateVersion(){
        $("#version").find('option').remove().end().append('<option value="none">none</option>').val('none');

        const selectedCategory = $("#category").val();
        const selectedBrand = $("#brand").val();
        const selectedName = $("#name").val();

        $.ajax({
            url: "/versionsForNameBrandAndCategory",
            contentType : "application/json",
            data: {"category": selectedCategory, "brand": selectedBrand, "name" : selectedName},
            type: "GET",
            dataType : "json",
        })
        .done(function( versions ) {
            console.log(versions);
            versions.forEach(addVersionsToHtmlSelect);
        })
        .fail(function( xhr, status, errorThrown ) {
            alert( "Sorry, there was a problem!" );
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
            console.dir( xhr );
        });
    }

    function addVersionsToHtmlSelect(item, index, array){
        $("<option>").text(item).appendTo("#version");
    }

    function populateProductNames(){
        $("#name").find('option').remove().end().append('<option value="none">none</option>').val('none');
        $("#version").find('option').remove().end().append('<option value="none">none</option>').val('none');

        const selectedCategory = $("#category").val();
        const selectedBrand = $("#brand").val();

        $.ajax({
            url: "/namesForCategoryAndBrand",
            contentType : "application/json",
            data: {"category": selectedCategory, "brand": selectedBrand},
            type: "GET",
            dataType : "json",
        })
        .done(function( brands ) {
            console.log(brands);
            brands.forEach(addNameToHtmlSelect);
        })
        .fail(function( xhr, status, errorThrown ) {
            alert( "Sorry, there was a problem!" );
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
            console.dir( xhr );
        });
    }

    function addNameToHtmlSelect(item, index, array){
        $("<option>").text(item).appendTo("#name");
    }

    function populateBrands(){
        $("#brand").find('option').remove().end().append('<option value="none">none</option>').val('none');
        $("#name").find('option').remove().end().append('<option value="none">none</option>').val('none');
        $("#version").find('option').remove().end().append('<option value="none">none</option>').val('none');

        const selectedCategory = $("#category").val();

        $.ajax({
            url: "/brandsForCategory",
            contentType : "application/json",
            data: {"category": selectedCategory},
            type: "GET",
            dataType : "json",
        })
        .done(function( brands ) {
            console.log(brands);
            brands.forEach(addBrandToHtmlSelect);
        })
        .fail(function( xhr, status, errorThrown ) {
            alert( "Sorry, there was a problem!" );
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
            console.dir( xhr );
        });
    }

    function addBrandToHtmlSelect(item, index, array){
        $("<option>").text(item).appendTo("#brand");
    }

    function find(){
        const selectedCategory = $("#category").val();
        const selectedBrand = $("#brand").val();
        const selectedName = $("#name").val();
        const selectedVersion = $("#version").val();

        const postData = {
            "category": selectedCategory,
            "brand": selectedBrand,
            "productName": selectedName,
            "productVersion": selectedVersion,
            "size": "12",
            "color" : "yellow",
            "page": 0
        }
        console.log("sending to server...");
        console.log(postData);

        $.ajax({
                url: "/search",
                contentType : "application/json",
                data: JSON.stringify(postData),
                type: "POST",
                dataType : "json",
         })
         .done(function( searchResultArray ) {
                console.log(searchResultArray);
                searchResultArray.forEach(addSearchResultItem);
         })
         .fail(function( xhr, status, errorThrown ) {
            alert( "Sorry, there was a problem!" );
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
            console.dir( xhr );
         })
         .always(function( xhr, status ) {
            console.log( "The request is complete!" );
         });
    }

    function addSearchResultItem(item, index, arr) {
         console.log(item);
         const resultLineDiv = $("<div>");
         $("#searchResults").append(resultLineDiv);
         resultLineDiv.append($("<a>").text(item.brandNameVersion).attr("href", item.link));
    }
</script>
<script>
    $( document ).ready(function() {
        console.log( "document loaded" );
    });

    $( window ).on( "load", function() {
        console.log( "window loaded" );
    });
</script>

</body>
</html>
